name: Build and Release Android/FDroid

on:
  workflow_dispatch:
  push:
    tags:
      - "v*"

env:
  JKS_PASSWORD: ${{ secrets.JKS_PASSWD }}

jobs:
  build:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: env
        run: cat build.env >> $GITHUB_ENV

      - name: Clean
        id: clean
        run: ./build-scripts/clean-runner.sh

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin' # Or 'zulu', 'adopt', etc.
          cache: 'gradle' # Optional: Caches Gradle dependencies

      - name: Build
        id: build
        run: |
          ./build-scripts/build-android.sh
          echo "ANDROID_NDK_ROOT=$HOME/Android/sdk/ndk/29.0.14206865" >> $GITHUB_ENV

      - name: Release
        uses: softprops/action-gh-release@v1
        if: startsWith(github.ref, 'refs/tags/v')
        with:
          files: |
            ${{ steps.build.outputs.BUILD_DIR }}/app-fdroid.aab
            ${{ steps.build.outputs.BUILD_DIR }}/app-fdroid.apk

      - name: publish
        uses: r0adkll/upload-google-play@v1
        if: startsWith(github.ref, 'refs/tags/v')
        continue-on-error: true
        with:
          serviceAccountJsonPlainText: ${{ secrets.SERVICE_ACCOUNT_JSON }}
          packageName: me.hanh.ywallet
          releaseFiles: ${{ steps.build.outputs.BUILD_DIR }}/app-fdroid.aab
          track: internal
          status: completed

      - uses: actions/upload-artifact@v4
        with:
          name: APK
          path: ${{ steps.build.outputs.BUILD_DIR }}/app-fdroid.apk
          retention-days: 3
